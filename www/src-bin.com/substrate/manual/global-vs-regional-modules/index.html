<!doctype HTML>
<html lang="en">
<meta charset="utf-8">
<head>
<link href="/css/2019-11-01.css" rel="stylesheet">
<title>Source &amp; Binary / Global versus regional modules</title>
</head>
<body>
<header><h1><a href="/">Source <span class="fancy">&amp;</span> Binary</a></h1></header>

<h1>Global versus regional modules</h1>

<p>Substrate generates a lot of Terraform code in modules with leaf directory names of <code>global</code> and <code>regional</code>. This is necessary because certain AWS services are global - IAM, notably - and thus their resources cannot be successfully managed from two AWS regions in two regional Terraform statefiles. Doing so will cause conflicts that generally aren&rsquo;t detected in Terraform plans but nonetheless fail when changes are applied. It&rsquo;s not simply a matter of importing resources, either, because every change will cause those imported copies to drift and require manual intervention. Thus, <code>global</code> and <code>regional</code> modules are the best structure.</p>

<p>Terraform resources for global AWS services like CloudFront, IAM, and Route 53 should be placed in a <code>global</code> module. (If you&rsquo;re in doubt as to whether an AWS service is global or regional, check for a region in its resources&rsquo; ARNs.) Terraform resources for pseudo-global services like Lambda@Edge or ACM when certificates are used with CloudFront distributions should be placed in a <code>global</code> module <em>and</em> specifiy <code>provider = aws.us-east-1</code> as these services (and possibly others; see the AWS documentation) <em>must</em> be managed from us-east-1 and only from us-east-1.</p>

<p>If you have global singleton resources, even from AWS serivces that are regional, and you want them to exist in your default region or us-east-1, you may define them in a <code>global</code> module. If, however, you have global singleton resources that you want to exist in another region, use <code>substrate-create-terraform-module</code> and then instantiate that module in <code>root-modules/<em>domain</em>/<em>environment</em>/<em>quality</em>/<em>region</em>/main.tf</code>. If this singleton doesn&rsquo;t even need to be duplicated per environment, you can skip creating a module and instantiate the resource directly in some leaf subdirectory of <code>root-modules</code>, though beware that doing so gives up your ability to test changes to these resources.</p>

<p>It&rsquo;s common, once you&rsquo;ve created resources in a <code>global</code> module, to need to reference these resources from regional modules. Use Terraform data sources to lookup these resource by their name, tags, or the like in the accompanying <code>regional</code> module.</p>

<p>Of course, with every rule there are exceptions. Sometimes it&rsquo;s not possible (or is significantly harder) to create a global resource without first knowing something about a regional resource. A typical example would be an IAM role used as a service account for EKS pods; the IAM role&rsquo;s trust policy needs to know the identity of the cluster and its OAuth OIDC provider before it can be written. In such cases, the correct practice is to namespace the global resource (e.g. the IAM role) with at least the AWS region in which it&rsquo;s being created and possibly also the name of the regional resource that forced it to be regional, too.</p>

<footer>
<ul>
<li><a href="/services/">Services</a>: <small>infrastructure, architecture, compliance</small></li>
<li><a href="/substrate/">Substrate</a>, <small>my suite of AWS management tools</small></li>
</ul>
<p>Copyright &copy; 2020-2021 &mdash; Source <span class="fancy">&amp;</span> Binary LLC</p>
</footer>
</body>
</html>
