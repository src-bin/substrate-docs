<!doctype HTML>
<html lang="en">
    <head>
        <link href="/css/2022-08-29.css" rel="stylesheet">
        <meta charset="utf-8">
        <meta content="summary" name="twitter:card">
        <meta content="A page from the Substrate manual" name="twitter:description">
        <meta content="https://src-bin.com/img/apple-touch-icon.png" name="twitter:image">
        <meta content="@src_bin" name="twitter:site">
        <meta content="Source &amp; Binary / Substrate manual / Writing Terraform code with an assist from Substrate" name="twitter:title">
        <meta content="width=device-width,initial-scale=1" name="viewport">
        <meta content="A page from the Substrate manual" property="og:description">
        <meta content="https://src-bin.com/img/apple-touch-icon.png" property="og:image">
        <meta content="Source &amp; Binary / Substrate manual / Writing Terraform code with an assist from Substrate" property="og:title">
        <meta content="website" property="og:type">
        <meta content="https://src-bin.com/substrate/manual/writing-terraform-code/" property="og:url">
        <title>Source &amp; Binary / Writing Terraform code with an assist from Substrate</title>
    </head>
    <body>
        <header>
            <h1><a href="/">Source <span class="fancy">&amp;</span> Binary</a></h1>
            <p><a href="mailto:hello@src-bin.com">hello@src-bin.com</a></p>
            <aside>Purveyors&nbsp;of&nbsp;secure,&nbsp;reliable,&nbsp;and&nbsp;compliant&nbsp;cloud&nbsp;infrastructure&nbsp;since&nbsp;2020</aside>
            <nav>
                <ul>
                    <li><a href="/substrate/">Substrate</a></li>
                    <li><a href="/substrate/manual/">Documentation</a></li>
                    <li><a href="/substrate/pricing/">Pricing</a></li>
                    <!--<li><a href="/compliance/">Compliance Workshop</a></li>-->
                </ul>
            </nav>
        </header>

        <section>

<h1>Writing Terraform code with an assist from Substrate</h1>

<p>Substrate generates a directory structure for your Terraform code, remote state file configurations, provider configurations, and <code>module</code> blocks so you can get started right away writing Terraform code that matters to your&nbsp;business.</p>

<h2>Directory structure</h2>

<p><strong>tl;dr: Write code in the <code>modules</code> subdirectories Substrate creates for each domain. Run Terraform from the <code>root-modules</code> subdirectories matching the domain, environment, quality, and AWS region you want or just use <code>substrate create-account</code>.</strong></p>

<p>Suppose you&rsquo;re responsible for a service called <em>example</em> that you run in <em>staging</em> as <em>alpha</em>-quality and in <em>production</em> as <em>beta</em>- and <em>gamma</em>-quality. You will create those environments and qualities interactively with <code>substrate bootstrap-network-account</code> and will then run the following commands to create all your service&nbsp;accounts:</p>

<ul>
<li><code>substrate create-account -domain example -environment staging -quality alpha</code></li>
<li><code>substrate create-account -domain example -environment production -quality beta</code></li>
<li><code>substrate create-account -domain example -environment production -quality gamma</code></li>
</ul>

<p>These will create the following directory trees, which you will should commit to version&nbsp;control:</p>

<ul>
<li><code>modules</code>
<ul>
<li><code>common</code>
<ul>
<li><code>global</code></li>
<li><code>regional</code></li>
</ul></li>
<li><code>example</code>
<ul>
<li><code>global</code></li>
<li><code>regional</code></li>
</ul></li>
</ul></li>
<li><code>root-modules</code>
<ul>
<li><code>example</code>
<ul>
<li><code>staging</code>
<ul>
<li><code>alpha</code>
<ul>
<li><code>global</code></li>
<li><code>us-east-2</code></li>
<li><code>us-west-2</code></li>
</ul></li>
</ul></li>
<li><code>production</code>
<ul>
<li><code>beta</code>
<ul>
<li><code>global</code></li>
<li><code>us-east-2</code></li>
<li><code>us-west-2</code></li>
</ul></li>
<li><code>gamma</code>
<ul>
<li><code>global</code></li>
<li><code>us-east-2</code></li>
<li><code>us-west-2</code></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul>

<p>What do you do next? And where do you do&nbsp;it?</p>

<p>The vast majority of your work should happen in your domain&rsquo;s Terraform modules. In this <em>example</em> domain those are <code>modules/example/global</code> and <code>modules/example/regional</code>. Put global resources like IAM roles and Route 53 records in <code>modules/example/global</code>. Put regional resources like autoscaling groups and EKS clusters in <code>modules/example/regional</code>. (Substrate has generated all the <code>module</code> blocks necessary to instantiate these modules with the right Terraform&nbsp;providers.)</p>

<p>You selected some number of AWS regions when you configured your network but you may not want to run all your infrastructure in all those regions all the time (if for no other reason than cost control). You may edit <code>root-modules/*/*/*/*/main.tf</code> to customize which of your selected regions are actually in use. By default, all your selected regions are in use. If you don&rsquo;t want to provision your infrastructure in any of them, simply comment out the resources in <code>root-modules/*/*/*/*/main.tf</code> (substituting your domains, environments, qualities, and regions as&nbsp;desired).</p>

<p>Every domain module automatically instantiates a common module, too. Here, <code>modules/example/global</code> instantiates <code>modules/common/global</code> and <code>modules/example/regional</code> instantiates <code>modules/common/regional</code>. These common modules, following the now-familiar pattern of <a href="../global-and-regional-terraform-modules/">global and regional Terraform modules</a>, are for resources that should exist in every service account. Note that the common modules are not instantiated in admin accounts or the audit, deploy, management, or network&nbsp;accounts.</p>

<h2>Testing and deploying Terraform changes</h2>

<p>It&rsquo;s no accident that <code>modules/example/global</code> and <code>modules/example/regional</code> are referenced by the root Terraform modules for every environment and quality in the domain. These afford you multiple opportunities to implement changes in pre-<em>production</em> and partial-<em>production</em> in order to catch more bugs and failures before they impact all your capacity and all your customers. Continuing from the example above, here is the complete lifecycle of a Terraform change in the <em>example</em>&nbsp;domain:</p>

<ol>
<li>Change e.g. an EC2 launch template in <code>modules/example/regional/main.tf</code></li>
<li>Commit, push, get a code review, and merge into the main&nbsp;branch</li>
<li><code>substrate create-account -domain example -environment staging -quality alpha</code> and verify your&nbsp;changes</li>
<li><code>substrate create-account -domain example -environment production -quality beta</code> and verify your changes, either at the end or at each pause between&nbsp;regions</li>
<li><code>substrate create-account -domain example -environment production -quality gamma</code> and verify your changes, either at the end or at each pause between&nbsp;regions</li>
</ol>

<h1>Referencing Substrate parameters in Terraform</h1>

<p>As you write your own Terraform modules, you&rsquo;re certainly going to want to parameterize them in the same ways Substrate helps you parameterize your AWS accounts. Plus, you&rsquo;re also going to need a network, and Substrate&rsquo;s already created some and shared the right one with every service account to make it easy, secure, and cost-effective to build new&nbsp;things.</p>

<p><code>substrate create-account</code> automatically creates global and regional Terraform modules for your domain in <code>modules/<em>domain</em></code>. Those modules include a reference to <code>modules/substrate</code> which provides the following helpful&nbsp;context:</p>

<ul>
<li><code>module.substrate.tags.domain</code>: The domain of this AWS account, from the tags on the account&nbsp;itself.</li>
<li><code>module.substrate.tags.environment</code>: The environment of this AWS account, from the tags on the account&nbsp;itself.</li>
<li><code>module.substrate.tags.quality</code>: The quality of this AWS account, from the tags on the account&nbsp;itself.</li>
<li><code>module.substrate.cidr_prefix</code>: The CIDR prefix of this environment/quality&rsquo;s shared&nbsp;VPC.</li>
<li><code>module.substrate.private_subnet_ids</code>: A <em>set</em> of three private subnet IDs in this environment/quality&rsquo;s shared&nbsp;VPC.</li>
<li><code>module.substrate.public_subnet_ids</code>: A <em>set</em> of three public subnet IDs in this environment/quality&rsquo;s shared VPC. (This set is empty in admin&nbsp;accounts.)</li>
<li><code>module.substrate.vpc_id</code>: The ID of this environment/quality&rsquo;s shared&nbsp;VPC.</li>
</ul>

        </section>

        <footer>
            <p class="fine-print">&copy; 2020-2022 &mdash; Source <span class="fancy">&amp;</span> Binary&nbsp;LLC</p>
        </footer>
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-T1M8F1RWMC"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'G-T1M8F1RWMC');
        </script>
    </body>
</html>
