<!doctype HTML>
<html lang="en">
    <meta charset="utf-8">
    <head>
        <!--<link href="https://src-bin.com/" rel="canonical">-->
        <link href="/css/2022-03-03.css" rel="stylesheet">
        <meta property="og:description" content="A page from the Substrate manual">
        <meta property="og:image" content="https://src-bin.com/img/apple-touch-icon.png">
        <meta property="og:title" content="Source &amp; Binary / Substrate manual / Your daily workflow in your Substrate-managed AWS organization">
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://src-bin.com/substrate/manual/your-daily-workflow/">
        <meta name="twitter:card" content="summary">
        <meta name="twitter:description" content="A page from the Substrate manual">
        <meta name="twitter:image" content="https://src-bin.com/img/apple-touch-icon.png">
        <meta name="twitter:site" content="@src_bin">
        <meta name="twitter:title" content="Source &amp; Binary / Substrate manual / Your daily workflow in your Substrate-managed AWS organization">
        <title>Source &amp; Binary / Your daily workflow in your Substrate-managed AWS organization</title>
    </head>
    <body>
        <header>
            <h1><a href="/">Source <span class="fancy">&amp;</span> Binary</a></h1>
            <p><a href="mailto:hello@src-bin.com">hello@src-bin.com</a></p>
            <aside>Purveyors&nbsp;of&nbsp;secure,&nbsp;reliable,&nbsp;and&nbsp;compliant&nbsp;cloud&nbsp;infrastructure&nbsp;since&nbsp;2020</aside>
            <nav>
                <ul>
                    <li><a href="/">Benefits</a></li>
                    <li><a href="/substrate/">Features</a></li>
                    <li><a href="/substrate/manual/">Documentation</a></li>
                    <li><a href="/substrate/pricing/">Pricing</a></li>
                    <!--<li><a href="/compliance/">Compliance Workshop</a></li>-->
                </ul>
            </nav>
        </header>

        <section>

<h1>Your daily workflow in your Substrate-managed AWS organization</h1>

<p>You&rsquo;ve reached the end of the <a href="/substrate/manual/getting-started/">getting started</a> guide and <a href="/substrate/manual/your-aws-organization">you understand your Substrate-managed AWS organization</a>. Now what? Now you get to work. Here&rsquo;s how.</p>

<h3>Networks</h3>

<p>Your networks, all in your network account, are tagged according to their environment and quality. Unfortunately, those tags aren&rsquo;t visible outside the network account, so in order to see those, you&rsquo;ll need to assume the <code>Auditor</code> or <code>NetworkAdministrator</code> role in your network account.</p>

<p>This is, in practice, a rare occurrence because the <code>substrate</code> module that&rsquo;s automatically instantiated in all your domain Terraform modules gives you a quick reference to the correct public and private subnets via <code>module.substrate.public_subnet_ids</code> and <code>module.substrate.private_subnet_ids</code>.</p>

<h2>Organizing your code</h2>

<p><strong>tl;dr: Write code in the <code>modules</code> subdirectories Substrate creates for you. Run Terraform from the <code>root-modules</code> subdirectories matching the domain, environment, quality, and AWS region you want.</strong></p>

<p>Suppose you&rsquo;re responsible for a service called <em>example</em> that you run in <em>staging</em> as <em>alpha</em>-quality and in <em>production</em> as <em>beta</em>- and <em>gamma</em>-quality. You will have run the following commands to create all the AWS accounts:</p>

<ul>
<li><code>substrate-create-account -domain=example -environment=staging -quality=alpha</code></li>
<li><code>substrate-create-account -domain=example -environment=production -quality=beta</code></li>
<li><code>substrate-create-account -domain=example -environment=production -quality=gamma</code></li>
</ul>

<p>These will create the following directory trees, which you will have committed to version control:</p>

<ul>
<li><code>modules</code>
<ul>
<li><code>example</code>
<ul>
<li><code>global</code></li>
<li><code>regional</code></li>
</ul></li>
</ul></li>
<li><code>root-modules</code>
<ul>
<li><code>example</code>
<ul>
<li><code>staging</code>
<ul>
<li><code>alpha</code>
<ul>
<li><code>global</code></li>
<li><code>us-east-2</code></li>
<li><code>us-west-2</code></li>
</ul></li>
</ul></li>
<li><code>production</code>
<ul>
<li><code>beta</code>
<ul>
<li><code>global</code></li>
<li><code>us-east-2</code></li>
<li><code>us-west-2</code></li>
</ul></li>
<li><code>gamma</code>
<ul>
<li><code>global</code></li>
<li><code>us-east-2</code></li>
<li><code>us-west-2</code></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul>

<p>What do you do next? And where do you do it?</p>

<p>The vast majority of your work should happen in your domain&rsquo;s Terraform modules. In this <em>example</em> domain those are <code>modules/example/global</code> and <code>modules/example/regional</code>. Put global resources like IAM roles and Route 53 records in <code>modules/example/global</code>. Put regional resources like autoscaling groups and EKS clusters in <code>modules/example/regional</code>. (Substrate has generated all the <code>module</code> blocks necessary to instantiate these modules with the right Terraform providers.)</p>

<p>You selected some number of AWS regions when you configured your network but you may not want to run all your infrastructure in all those regions all the time (if for no other reason than cost control). You may edit <code>root-modules/*/*/*/*/main.tf</code> to customize which of your selected regions are actually in use. By default, all your selected regions are in use. If you don&rsquo;t want to provision your infrastructure in any of them, simply comment out the resources in <code>root-modules/*/*/*/*/main.tf</code> (substituting your domains, environments, qualities, and regions as desired).</p>

<p><a href="../referencing-substrate-parameters-in-terraform/">Referencing Substrate parameters in Terraform</a> documents how, within these modules and files, you can parameterize your own code by domain, environment, and quality and make use of the VPC Substrate automatically shares with each AWS account.</p>

<h2>Testing and deploying Terraform changes</h2>

<p>It&rsquo;s no accident that <code>modules/example/global</code> and <code>modules/example/regional</code> are referenced by the root Terraform modules for every environment and quality in the domain. These afford you multiple opportunities to implement changes in pre-<em>production</em> and partial-<em>production</em> in order to catch more bugs and failures before they impact all your capacity and all your customers. Continuing from the example above, here is the complete lifecycle of a Terraform change in the <em>example</em> domain:</p>

<ol>
<li>Change e.g. an EC2 launch template in <code>example/regional/main.tf</code></li>
<li>Commit, push, get a code review, and merge into the main branch</li>
<li><code>make -C root-modules/example/staging/alpha/us-east-2 plan</code> and inspect the output</li>
<li><code>make -C root-modules/example/staging/alpha/us-east-2 apply</code></li>
<li>Verify the correctness of the change in your <em>staging</em> environment</li>
<li><code>make -C root-modules/example/production/beta/us-east-2 plan</code> and inspect the output</li>
<li><code>make -C root-modules/example/production/beta/us-east-2 apply</code></li>
<li>Observe your product&rsquo;s behavior in your <em>production</em> environment for long enough to convince yourself the change is correct
<ul>
<li>If your beta-quality infrastructure sees only a tiny trickle of traffic, this may take a while</li>
<li>As you mature, it&rsquo;ll become more and more valuable to <a href="https://aws.amazon.com/builders-library/automating-safe-hands-off-deployments/">automate</a> this observation step</li>
</ul></li>
<li><code>make -C root-modules/example/production/gamma/us-east-2 plan</code> and inspect the output</li>
<li><code>make -C root-modules/example/production/gamma/us-east-2 apply</code></li>
<li>Observe your product&rsquo;s behavior in your <em>production</em> environment for long enough to convince yourself the change is correct
<ul>
<li>Now that your change has landed everywhere, this should be a much shorter time</li>
</ul></li>
</ol>

<p>Any failure or suspicious behavior is reason to abort, revert the change, and rollback all the changes you actually made.</p>

<p>All the steps in this process can easily be executed by CI/CD systems according to your preferences. A CI/CD system running in AWS can be granted <code>Administrator</code> privileges directly. A CI/CD system offered as SaaS may be able to assume an IAM role but, more likely, you&rsquo;ll need to define an <code>aws_iam_user</code> resource in your admin account and arrange to provide an access key for that user to your CI/CD system. (Don&rsquo;t forget to accommodate <em>and practice</em> access key rotation!)</p>

        </section>

        <footer>
            <p class="fine-print">&copy; 2020-2022 &mdash; Source <span class="fancy">&amp;</span> Binary&nbsp;LLC</p>
        </footer>
    </body>
</html>
