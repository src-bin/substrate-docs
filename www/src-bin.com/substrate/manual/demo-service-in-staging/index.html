<!doctype HTML>
<html lang="en">
    <meta charset="utf-8">
    <head>
        <!--<link href="https://src-bin.com/" rel="canonical">-->
        <link href="/css/2022-03-03.css" rel="stylesheet">
        <meta property="og:description" content="A page from the Substrate manual">
        <meta property="og:image" content="https://src-bin.com/img/apple-touch-icon.png">
        <meta property="og:title" content="Source &amp; Binary / Substrate manual / Provision the demo service in staging">
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://src-bin.com/substrate/manual/demo-service-in-staging/">
        <meta name="twitter:card" content="summary">
        <meta name="twitter:description" content="A page from the Substrate manual">
        <meta name="twitter:image" content="https://src-bin.com/img/apple-touch-icon.png">
        <meta name="twitter:site" content="@src_bin">
        <meta name="twitter:title" content="Source &amp; Binary / Substrate manual / Provision the demo service in staging">
        <title>Source &amp; Binary / Provision the demo service in staging</title>
    </head>
    <body>
        <header>
            <h1><a href="/">Source <span class="fancy">&amp;</span> Binary</a></h1>
            <p><a href="mailto:hello@src-bin.com">hello@src-bin.com</a></p>
            <aside>Purveyors&nbsp;of&nbsp;secure,&nbsp;reliable,&nbsp;and&nbsp;compliant&nbsp;cloud&nbsp;infrastructure&nbsp;since&nbsp;2020</aside>
            <nav>
                <ul>
                    <li><a href="/">Benefits</a></li>
                    <li><a href="/substrate/">Features</a></li>
                    <li><a href="/substrate/manual/">Documentation</a></li>
                    <li><a href="/pricing/">Pricing</a></li>
                    <!--<li><a href="/compliance/">Compliance Workshop</a></li>-->
                </ul>
            </nav>
        </header>

        <section>

<h1>Provision the demo service in staging</h1>

<p><em>This section is a work in-progress and will be expanded.</em></p>

<p>We&rsquo;re going to pick up where the <a href="/substrate/manual/getting-started/">getting started</a> guide left your staging environment and provision a real service there.</p>

<p>Because AWS accounts are notoriously tedious to close, feel free to use a domain, environment, and quality that suit your organization instead of the placeholders used here.</p>

<p>Ensure the environment and quality you wish to use is a valid pair by re-running <code>substrate-bootstrap-network-account</code>. If you wish to follow the tutorial to the letter, allow <em>beta</em>-quality infrastructure in the <em>staging</em> environment.</p>

<p>Run <code>substrate-create-account -domain="demo" -environment="staging" -quality="beta"</code> to (re)create the AWS account and generate the structure of the Terraform code.</p>

<p>For this tutorial we&rsquo;re going to use the DNS to route traffic but this could just as easily be done via your favorite edge load balancing and routing software.</p>

<p>Buy a domain name to use in staging or delegate a zone from a domain you already own. If you&rsquo;re buying a domain name, buy it using Route 53 Domains in your demo staging alpha account.</p>

<p>In <code>modules/demo/global/main.tf</code>, add the following code (substituting the domain names and regions you&rsquo;re using):</p>

<pre><code>locals {
  domain_name = module.substrate.tags.environment == "production" ? "src-bin.com" : "src-bin.org"
}

resource "aws_acm_certificate" "demo" {
  domain_name       = "demo.${local.domain_name}"
  validation_method = "DNS"
}

resource "aws_acm_certificate_validation" "demo" {
  certificate_arn         = aws_acm_certificate.demo.arn
  validation_record_fqdns = [for record in aws_route53_record.domain-validation : record.fqdn]
}

resource "aws_route53_record" "demo" {
  for_each = toset(["us-east-2", "us-west-2"])

  latency_routing_policy {
    region = each.key
  }
  name           = "global"
  records        = ["${each.key}.${aws_route53_zone.demo.name}"]
  set_identifier = each.key
  ttl            = 1
  type           = "CNAME"
  zone_id        = aws_route53_zone.demo.zone_id
}

resource "aws_route53_record" "domain-validation" {
  for_each = {
    for dvo in aws_acm_certificate.demo.domain_validation_options : dvo.domain_name =&gt; {
      name   = dvo.resource_record_name
      record = dvo.resource_record_value
      type   = dvo.resource_record_type
    }
  }

  name    = each.value.name
  records = [each.value.record]
  ttl     = 60
  type    = each.value.type
  zone_id = data.aws_route53_zone.demo.zone_id
}

resource "aws_route53_zone" "demo" {
  name = "${module.substrate.tags.quality}.demo.${local.domain_name}"
}
</code></pre>

<p>In <code>modules/demo/regional/main.tf</code>, add the following code:</p>

<pre><code>data "aws_region" "current" {}

data "aws_route53_zone" "demo" {
  name = "${module.substrate.tags.quality}.demo.${local.domain_name}"
}

locals {
  body        = &lt;&lt;EOF
&lt;!doctype HTML&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
&lt;meta charset="utf-8"&gt;
&lt;title&gt;Substrate Demo&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Substrate Demo&lt;/h1&gt;
&lt;dl&gt;
&lt;dt&gt;Domain&lt;/dt&gt;&lt;dd&gt;${module.substrate.tags.domain}&lt;/dd&gt;
&lt;dt&gt;Environment&lt;/dt&gt;&lt;dd&gt;${module.substrate.tags.environment}&lt;/dd&gt;
&lt;dt&gt;Quality&lt;/dt&gt;&lt;dd&gt;${module.substrate.tags.quality}&lt;/dd&gt;
&lt;dt&gt;Region&lt;/dt&gt;&lt;dd&gt;${data.aws_region.current.name}&lt;/dd&gt;
&lt;/dl&gt;
&lt;/body&gt;
&lt;/html&gt;
EOF
  domain_name = module.substrate.tags.environment == "production" ? "src-bin.com" : "src-bin.org"
}

resource "aws_acm_certificate" "demo" {
  domain_name       = "demo.${local.domain_name}"
  validation_method = "DNS"
}

resource "aws_acm_certificate_validation" "demo" {
  certificate_arn         = aws_acm_certificate.demo.arn
  validation_record_fqdns = [for record in aws_route53_record.demo : record.fqdn]
}

resource "aws_lb" "demo" {
  internal           = false
  load_balancer_type = "application"
  name               = "demo"
  security_groups    = [aws_security_group.demo-alb.id]
  subnets            = module.substrate.private_subnet_ids
}

resource "aws_lb_listener" "http" {
  default_action {
    fixed_response {
      content_type = "text/html"
      message_body = local.body
      status_code  = 200
    }
    type = "fixed-response"
  }
  load_balancer_arn = aws_lb.demo.arn
  port              = 80
  protocol          = "HTTP"
}


resource "aws_lb_listener" "https" {
  certificate_arn = aws_acm_certificate_validation.demo.certificate_arn
  default_action {
    fixed_response {
      content_type = "text/html"
      message_body = local.body
      status_code  = 200
    }
    type = "fixed-response"
  }
  load_balancer_arn = aws_lb.demo.arn
  port              = 443
  protocol          = "HTTPS"
  ssl_policy        = "ELBSecurityPolicy-FS-1-2-Res-2020-10"
}

resource "aws_route53_record" "demo" {
  alias {
    evaluate_target_health = false
    name                   = aws_lb.demo.dns_name
    zone_id                = aws_lb.demo.zone_id
  }
  name    = data.aws_region.current.name
  type    = "A"
  zone_id = data.aws_route53_zone.demo.zone_id
}

resource "aws_security_group" "demo-alb" {
  ingress {
    cidr_blocks = ["0.0.0.0/0"]
    description = "HTTP"
    from_port   = 80
    protocol    = "tcp"
    to_port     = 80
  }
  ingress {
    cidr_blocks = ["0.0.0.0/0"]
    description = "HTTPS"
    from_port   = 443
    protocol    = "tcp"
    to_port     = 443
  }
  name   = "demo-alb"
  vpc_id = module.substrate.vpc_id
}
</code></pre>

<p>In <code>root-modules/demo/staging/alpha/main.tf</code>, add the following code:</p>

<pre><code>data "aws_route53_zone" "staging" {
  name = "${local.domain_name}."
}

locals {
  domain_name    = "src-bin.org"
}

resource "aws_route53_record" "CNAME-demo-alpha" {
  name           = "demo"
  records        = ["global.alpha.demo.${data.aws_route53_zone.staging.name}"]
  set_identifier = "alpha"
  ttl            = 1
  type           = "CNAME"
  weighted_routing_policy {
    weight = 100
  }
  zone_id = data.aws_route53_zone.staging.zone_id
}
</code></pre>

<p>Once more, run <code>substrate-create-account -domain="demo" -environment="staging" -quality="beta"</code>, this time to run all your Terraform code to create the DNS records, certificate, and ALB we just described.</p>

<p>Visit <a href="https://demo.src-bin.org">https://demo.src-bin.org</a> (substituting your domain name (or not)) to see the fruits of your labor.</p>

<p>Iterate on this to your heart&rsquo;s content. Add EC2 auto-scaling groups, other compute resources, databases, or whatever else you need to support your service.</p>

<p>When you&rsquo;re happy with what you&rsquo;ve built, move on to <a href="/substrate/manual/demo-service-in-production/">provision the demo service in production</a>.</p>

        </section>

        <footer>
            <p class="fine-print">&copy; 2020-2022 &mdash; Source <span class="fancy">&amp;</span> Binary&nbsp;LLC</p>
        </footer>
    </body>
</html>
