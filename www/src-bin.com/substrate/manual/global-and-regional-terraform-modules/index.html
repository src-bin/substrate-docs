<!doctype HTML>
<html lang="en">
    <head>
        <link href="/css/2022-08-29.css" rel="stylesheet">
        <meta charset="utf-8">
        <meta content="summary" name="twitter:card">
        <meta content="A page from the Substrate manual" name="twitter:description">
        <meta content="https://src-bin.com/img/apple-touch-icon.png" name="twitter:image">
        <meta content="@src_bin" name="twitter:site">
        <meta content="Source &amp; Binary / Substrate manual / Global and regional Terraform modules" name="twitter:title">
        <meta content="width=device-width,initial-scale=1" name="viewport">
        <meta content="A page from the Substrate manual" property="og:description">
        <meta content="https://src-bin.com/img/apple-touch-icon.png" property="og:image">
        <meta content="Source &amp; Binary / Substrate manual / Global and regional Terraform modules" property="og:title">
        <meta content="website" property="og:type">
        <meta content="https://src-bin.com/substrate/manual/global-and-regional-terraform-modules/" property="og:url">
        <title>Source &amp; Binary / Global and regional Terraform modules</title>
    </head>
    <body>
        <header>
            <h1><a href="/">Source <span class="fancy">&amp;</span> Binary</a></h1>
            <p><a href="mailto:hello@src-bin.com">hello@src-bin.com</a></p>
            <aside>Purveyors&nbsp;of&nbsp;secure,&nbsp;reliable,&nbsp;and&nbsp;compliant&nbsp;cloud&nbsp;infrastructure&nbsp;since&nbsp;2020</aside>
            <nav>
                <ul>
                    <li><a href="/substrate/">Substrate</a></li>
                    <li><a href="/substrate/manual/">Documentation</a></li>
                    <li><a href="/substrate/pricing/">Pricing</a></li>
                    <!--<li><a href="/compliance/">Compliance Workshop</a></li>-->
                </ul>
            </nav>
        </header>

        <section>

<h1>Global and regional Terraform modules</h1>

<p>Substrate generates a lot of Terraform code in modules with leaf directory names of <code>global</code> and <code>regional</code>. This is necessary because certain AWS services are global - IAM, notably - and thus their resources cannot be successfully managed from two AWS regions in two regional Terraform statefiles. Doing so will cause conflicts that generally aren&rsquo;t detected in Terraform plans but nonetheless fail when changes are applied. It&rsquo;s not simply a matter of importing resources, either, because every change will cause those imported copies to drift and require manual intervention. Thus, <code>global</code> and <code>regional</code> modules are the best&nbsp;structure.</p>

<p>Terraform resources for global AWS services like CloudFront, IAM, and Route 53 should be placed in a <code>global</code> module. (If you&rsquo;re in doubt as to whether an AWS service is global or regional, check for a region in its resources&rsquo;&nbsp;ARNs.)</p>

<p>Terraform resources for pseudo-global services like Lambda@Edge, ACM when certificates are used with CloudFront distributions, Route 53 Domains, and possibly others should be placed in a <code>global</code> module <em>and</em> specifiy <code>provider = aws.us-east-1</code> as these services <em>must</em> be managed from us-east-1 and only from&nbsp;us-east-1.</p>

<p>If you have global singleton resources, even from AWS serivces that are regional, and you want them to exist in your default region or us-east-1, you may define them in a <code>global</code> module. If, however, you have global singleton resources that you want to exist in another region, use <code>substrate create-terraform-module</code> and then instantiate that module in <code>root-modules/<em>domain</em>/<em>environment</em>/<em>quality</em>/<em>region</em>/main.tf</code>. If this singleton doesn&rsquo;t even need to be duplicated per environment, you can skip creating a module and instantiate the resource directly in some leaf subdirectory of <code>root-modules</code>, though beware that doing so gives up your ability to test changes to these&nbsp;resources.</p>

<p>It&rsquo;s common, once you&rsquo;ve created resources in a <code>global</code> module, to need to reference these resources from regional modules. Use Terraform data sources to lookup these resource by their name, tags, or the like in the accompanying <code>regional</code>&nbsp;module.</p>

<h2>Alternatively, namespace global resources in regional modules</h2>

<p>Of course, with every rule there are exceptions. Sometimes it&rsquo;s not possible (or is significantly harder) to create a global resource without first knowing something about a regional resource. A typical example would be an IAM role used as a service account for EKS pods; the IAM role&rsquo;s trust policy needs to know the identity of the cluster and its OAuth OIDC provider before it can be written. In such cases, the correct practice is to namespace the global resource (e.g. the IAM role) with at least the AWS region in which it&rsquo;s being&nbsp;created.</p>

<pre><code>data "aws_region" "current" {}

resource "aws_iam_role" "example" {
    name = "example-${data.aws_region.current.name}"
}
</code></pre>

        </section>

        <footer>
            <p class="fine-print">&copy; 2020-2022 &mdash; Source <span class="fancy">&amp;</span> Binary&nbsp;LLC</p>
        </footer>
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-T1M8F1RWMC"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'G-T1M8F1RWMC');
        </script>
    </body>
</html>
