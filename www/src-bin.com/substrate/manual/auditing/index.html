<!doctype HTML>
<html lang="en">
<meta charset="utf-8">
<head>
<link href="/css/2019-11-01.css" rel="stylesheet">
<title>Source &amp; Binary / Auditing your Substrate-managed AWS organization</title>
</head>
<body>
<header><h1><a href="/">Source <span class="fancy">&amp;</span> Binary</a></h1></header>

<h1>Auditing your Substrate-managed AWS organization</h1>

<p>One of the very first things Substrate does is to configure AWS CloudTrail with a single trail that covers all organization accounts in all regions. To access this wealth of data, assume the <code>Auditor</code> role in your audit account.</p>

<p>On the command line: <code>substrate-assume-role -special="audit" -role="Auditor"</code></p>

<p>Or you can assume the role in the AWS Console. The audit account number is listed in <code>substrate.accounts.txt</code> for use with the AWS Console&rsquo;s <strong>Switch Role</strong> feature.</p>

<p>In either case, the data you seek is in the <code>PREFIX-cloudtrail</code> (substituting your chosen prefix as stored in <code>substrate.prefix</code>) S3 bucket. You can download it to analyze locally or <a href="https://docs.aws.amazon.com/athena/latest/ug/cloudtrail-logs.html">query it with Amazon Athena</a>. The most straightforward way to proceed is by creating Athena tables for each AWS account; partition projection to cover the entire organization is unsolved.</p>

<h2>Allowing third-parties to audit your Substrate-managed AWS organization</h2>

<p>Many tools have grown the ability to assume an IAM role in your AWS account to perform some auditing or monitoring feature on your behalf. To allow these into your AWS organization, create an assume role policy in <code>substrate.Auditor.assume-role-policy.json</code> with contents like this:</p>

<pre><code>{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": ["arn:aws:iam::ACCOUNT_NUMBER:role/ROLE_NAME"]
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
</code></pre>

<p>You can include as many principals as you&rsquo;d like and they can be IAM role ARNs (recommended) or AWS account numbers (as JSON strings).</p>

<p>Every time you update this file, you&rsquo;ll need to re-run whichever of <code>substrate-bootstrap-management-account</code>, <code>substrate-bootstrap-deploy-account</code>, <code>substrate-bootstrap-network-account</code>, <code>substrate-create-admin-account</code> (for each of your admin accounts), and/or <code>substrate-create-account</code> (for each of your service accounts) are relevant to your situation.</p>

<p>This will authorize third-party principals to <code>sts:AssumeRole</code> using the ARN of one of your Auditor roles and operate as you would there.</p>

<footer>
<ul>
<li><a href="/services/">Services</a>: <small>infrastructure, architecture, compliance</small></li>
<li><a href="/substrate/">Substrate</a>, <small>my suite of AWS management tools</small></li>
</ul>
<p>Copyright &copy; 2020-2021 &mdash; Source <span class="fancy">&amp;</span> Binary LLC</p>
</footer>
</body>
</html>
