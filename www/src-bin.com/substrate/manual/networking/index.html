<!doctype HTML>
<html lang="en">
    <meta charset="utf-8">
    <head>
        <!--<link href="https://src-bin.com/" rel="canonical">-->
        <link href="/css/2022-04-24.css" rel="stylesheet">
        <meta name="twitter:card" content="summary">
        <meta name="twitter:description" content="A page from the Substrate manual">
        <meta name="twitter:image" content="https://src-bin.com/img/apple-touch-icon.png">
        <meta name="twitter:site" content="@src_bin">
        <meta name="twitter:title" content="Source &amp; Binary / Substrate manual / Networking">
        <!--<meta name="viewport" content="width=device-width,initial-scale=1">-->
        <meta property="og:description" content="A page from the Substrate manual">
        <meta property="og:image" content="https://src-bin.com/img/apple-touch-icon.png">
        <meta property="og:title" content="Source &amp; Binary / Substrate manual / Networking">
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://src-bin.com/substrate/manual/networking/">
        <title>Source &amp; Binary / Networking</title>
    </head>
    <body>
        <header>
            <h1><a href="/">Source <span class="fancy">&amp;</span> Binary</a></h1>
            <p><a href="mailto:hello@src-bin.com">hello@src-bin.com</a></p>
            <aside>Purveyors&nbsp;of&nbsp;secure,&nbsp;reliable,&nbsp;and&nbsp;compliant&nbsp;cloud&nbsp;infrastructure&nbsp;since&nbsp;2020</aside>
            <nav>
                <ul>
                    <li><a href="/">Benefits</a></li>
                    <li><a href="/substrate/">Features</a></li>
                    <li><a href="/substrate/manual/">Documentation</a></li>
                    <li><a href="/substrate/pricing/">Pricing</a></li>
                    <!--<li><a href="/compliance/">Compliance Workshop</a></li>-->
                </ul>
            </nav>
        </header>

        <section>

<h1>Networking</h1>

<p>Substrate manages VPCs for you for each environment and quality pair, which it shares into the service account for each domain in that environment and quality. This serves to balance isolation between domains with practical connectivity necessary to deliver a higher-level&nbsp;service.</p>

<p>If you&rsquo;ve chosen to use multiple qualities, in search of incremental change to AWS resources, Substrate will peer the VPCs for each quality in an environment to create a flat network. This enables e.g. a fleet of web servers deployed to both beta and gamma quality to reach a database cluster running just at gamma&nbsp;quality.</p>

<p>If you&rsquo;ve chosen to use multiple regions, Substrate will peer all the VPCs in all your regions that share the same environment. This, too, creates a big flat network and removes a lot of friction from using both multiple AWS accounts and multiple&nbsp;regions.</p>

<p>To make all of this happen, Substrate actively manages the CIDR prefixes assigned to all your VPCs and ensures they do not&nbsp;overlap.</p>

<p>All your VPCs exist in your network account and are managed by Terraform code that is generated by <code>substrate bootstrap-network-account</code> in <code>root-modules/network</code>. You can re-run this Terraform code anytime by re-running <code>substrate bootstrap-network-account</code>.</p>

<h2>Subnets</h2>

<p>Substrate chooses the newest three availability zones in each region and creates a public and a private subnet in each of those availability zones. Each public subnet is an IPv4 /22; each private subnet is an IPv4 /20. Each subnet also assigns IPv6&nbsp;addresses.</p>

<p>The subnets come with unsurprising route tables. Public subnets get Internet Gateways. Private subnets get IPv6 Egress-Only Internet Gateways and, if you opt in, IPv4 NAT&nbsp;Gateways.</p>

<p>In your Terraform code, you can use <code>module.substrate.public_subnet_ids</code> and <code>module.substrate.private_subnet_ids</code> to get a <code>set(string)</code> of those three subnets to use in other Terraform resources that create clusters, define autoscaling groups, and so&nbsp;on.</p>

<h2>NAT Gateways</h2>

<p>NAT Gateways, when configured zonally as Substrate does, cost about $100 per environment/quality per region per month. Thus, the <code>substrate.nat-gateways</code> file is available to control whether they&rsquo;re provisioned at all. If they&rsquo;re not, your private subnets are limited to IPv6-only outbound connectivity. In practice, this is almost entirely sufficient, with the one glaring hole being access to <a href="https://github.com">https://github.com</a>.</p>

<h2>VPC Endpoints</h2>

<p>Substrate automatically configures the gateway-style VPC Endpoints for DynamoDB and S3. These two VPC Endpoints are free and can dramatically cut network transit costs you&nbsp;incur.</p>

<p>Interface-style VPC Endpoints (which are newer) are available for most other AWS services, however they come at a cost and so are not created by default. Many won&rsquo;t be worth the cost if usage is&nbsp;low.</p>

<p>However, some AWS services aren&rsquo;t yet available over IPv6, so these services will be unavailable from private subnets without either a VPC Endpoint or a NAT&nbsp;Gateway.</p>

<p>The interaction between VPC Endpoints and security groups in a shared VPC can be confusing. We&rsquo;ve verified that creating both the endpoint and its security group in your network account is the best path to&nbsp;follow.</p>

<h1>Security groups</h1>

<p>Substrate&rsquo;s VPCs and subnets are defined in the network account and shared into your service accounts. Security groups, though, exist in your service accounts. They can allow whatever traffic they want &mdash; CIDR prefixes and security group IDs from other domains being the most common&nbsp;sources.</p>

<p>In your Terraform code, you can use <code>module.substrate.vpc_id</code> to define security&nbsp;groups.</p>

<h2>Creating your own VPCs</h2>

<p>If for some reason you don&rsquo;t want to use the Substrate-managed VPCs, you&rsquo;re free to create your own directly in your service accounts. If you do so, and these VPCs are meant to interact with services in Substrate-managed VPCs, consider using Private Link or VPC Peering to more cost-effectively and securely integrate these&nbsp;VPCs.</p>

<p>Beware, though, that there&rsquo;s a per-byte cost for crossing a VPC boundary, even within an availability zone. It can add&nbsp;up.</p>

        </section>

        <footer>
            <p class="fine-print">&copy; 2020-2022 &mdash; Source <span class="fancy">&amp;</span> Binary&nbsp;LLC</p>
        </footer>
    </body>
</html>
